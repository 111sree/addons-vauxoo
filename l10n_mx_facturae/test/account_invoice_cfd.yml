-
  I create a cfd customer invoice
-
  !record {model: account.invoice, id: account_invoice_cfd0, view: account.invoice_form}:
    payment_term: account.account_payment_term_advance
    journal_id: l10n_mx_cfd_journal_0
    partner_id: l10n_mx_partner_address.res_partner_address_vauxoo_1
    reference_type: none
    name: 'Test cfd Customer Invoice'
    invoice_line:
      - product_id: product.product_product_5
        quantity: 22.0
-
  I rewrite the journal field (BUG I need overwrite two times this field for done! only in test yaml)
-
  !record {model: account.invoice, id: account_invoice_cfd0, view: account.invoice_form}:
    journal_id: l10n_mx_cfd_journal_0
-
  I check that Journal is cfd
-
  !assert {model: account.invoice, id: account_invoice_cfd0}:
    - journal_id.id == ref('l10n_mx_cfd_journal_0')
-
  I check that Initially customer invoice state is "Draft"
-
  !assert {model: account.invoice, id: account_invoice_cfd0}:
    - state == 'draft'
-
  I open invoice by clicking on Create button
-
  !workflow {model: account.invoice, action: invoice_open, ref: account_invoice_cfd0}
-
  I check that the invoice state is "Open"
-
  !assert {model: account.invoice, id: account_invoice_cfd0}:
    - state == 'open'
-
  I confirm l10n_mx attachment facturae cfd by clicking on confirm button
-
  !python {model: ir.attachment.facturae.mx}: |
    import netsvc
    wf_service = netsvc.LocalService("workflow")
    cfd_ids = self.search(cr, uid, [('invoice_id', '=', ref("account_invoice_cfd0") ), ('state', '<>', 'cancel')], limit=1)
    cfd_id = cfd_ids and cfd_ids[0] or False
    if cfd_id:
        wf_service.trg_validate(uid, 'ir.attachment.facturae.mx', cfd_id, 'action_confirm', cr)
-
  I sign l10n_mx attachment facturae cfd by clicking on sign button
-
  !python {model: ir.attachment.facturae.mx}: |
    import netsvc
    wf_service = netsvc.LocalService("workflow")
    cfd_ids = self.search(cr, uid, [('invoice_id', '=', ref("account_invoice_cfd0") ), ('state', '<>', 'cancel')], limit=1)
    cfd_id = cfd_ids and cfd_ids[0] or False
    if cfd_id:
        wf_service.trg_validate(uid, 'ir.attachment.facturae.mx', cfd_id, 'action_sign', cr)
-
  I check that the state in l10n_mx attachment facturae cfd is "Signed"
-
  !python {model: ir.attachment.facturae.mx}: |
    cfd_ids = self.search(cr, uid, [('invoice_id', '=', ref("account_invoice_cfd0") ), ('state', '<>', 'cancel')], limit=1)
    cfd_id = cfd_ids and cfd_ids[0] or False
    state = None
    if cfd_id:
        cfd = self.browse(cr, uid, [cfd_id])[0]
        state = cfd.state
    assert state=='signed', 'No signed state l10n_mx attachment facturae cfd'
    
-
  TODO I generate a printable l10n_mx attachment facturae cfd manualmente
-
  !python {model: account.invoice}: |
    import netsvc, tools, os
    invoice_obj = self.pool.get('account.invoice')
    invoice_id = invoice_obj.search(cr, uid, [('id', '=', ref('account_invoice_cfd0'))])[0]
    #(data, format) = netsvc.LocalService('report.account.invoice.facturae.webkit').create(cr, uid, [invoice_id], {}, {})
    (data, format) = netsvc.LocalService('report.account.invoice').create(cr, uid, [invoice_id], {}, {})##Temporal only for test
    if tools.config['test_report_directory']:
        file(os.path.join(tools.config['test_report_directory'], 'l10n_mx-facturae_cfd_report.'+format), 'wb+').write(data)
#TODO: Report a bug when test yaml generate a webkit report
#~ -
  #~ I generate a printable l10n_mx attachment facturae cfd by clicking on printable button
#~ -
  #~ !python {model: ir.attachment.facturae.mx}: |
    #~ import netsvc
    #~ wf_service = netsvc.LocalService("workflow")
    #~ cfd_ids = self.search(cr, uid, [('invoice_id', '=', ref("account_invoice_cfd0") ), ('state', '<>', 'cancel')], limit=1)
    #~ cfd_id = cfd_ids and cfd_ids[0] or False
    #~ if cfd_id:
        #~ #wf_service.trg_validate(uid, 'ir.attachment.facturae.mx', cfd_id, 'action_printable', cr)
        #~ #wf_service.trg_validate(uid, 'ir.attachment.facturae.mx', cfd_id, 'action_printable', cr)
        #~ #wf_service.trg_validate(uid, 'ir.attachment.facturae.mx', cfd_id, 'action_printable', cr)
        #~ #wf_service.trg_validate(uid, 'ir.attachment.facturae.mx', cfd_id, 'action_printable', cr)
        #~ self.action_printable(cr, uid, [cfd_id], context={})
#~ -
  #~ I check that the state in l10n_mx attachment facturae cfd is Printable
#~ -
  #~ !python {model: ir.attachment.facturae.mx}: |
    #~ cfd_ids = self.search(cr, uid, [('invoice_id', '=', ref("account_invoice_cfd0") ), ('state', '<>', 'cancel')], limit=1)
    #~ cfd_id = cfd_ids and cfd_ids[0] or False
    #~ state = None
    #~ if cfd_id:
        #~ cfd = self.browse(cr, uid, [cfd_id])[0]
        #~ state = cfd.state
    #~ assert state=='printable', 'No printable state l10n_mx attachment facturae cfd'
