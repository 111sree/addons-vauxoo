-
  1 To test the Mexican Electronic Payroll CFDI
-
  2 I check that Journal is cfdi_pac_finkok 
-
  !assert {model: hr.payslip, id: hr_payslip_al_cfdi0}:
    - journal_id.id == ref("l10n_mx_payroll_base.l10n_mx_cfdi_payroll_pac_finkok_journal_0")
-
  3 I check that Initially payroll state is "Draft" 
-
  !assert {model: hr.payslip, id: hr_payslip_al_cfdi0}:
    - state == 'draft'
-
  4 I confirm l10n_mx attachment payroll cfdi_pac_finkok by clicking on confirm button 
-
  !python {model: hr.payslip}: |
    import netsvc, tools, os, base64
    wf_service = netsvc.LocalService("workflow")
    self.hr_verify_sheet(cr, uid , [ref("hr_payslip_al_cfdi0")] ,context=context)
-
  5 I sign l10n_mx attachment facturae cfdi_pac_finkok by clicking on sign button upload pac
-
  !python {model: ir.attachment.facturae.mx}: |
    import netsvc, tools
    wf_service = netsvc.LocalService("workflow")
    cfdi_pac_finkok_ids = self.search(cr, uid, [('payroll_id', '=', ref("hr_payslip_al_cfdi0") ), ('state', '<>', 'cancel')], limit=1)
    cfdi_pac_finkok_id = cfdi_pac_finkok_ids and cfdi_pac_finkok_ids[0] or False
    if cfdi_pac_finkok_id:
        context.update({'active_model': 'hr.payslip','active_ids':[ref("hr_payslip_al_cfdi0")]})
        cfdi_pac_finkok = self.browse(cr, uid, [cfdi_pac_finkok_id], context=context)[0]
        self.signal_sign(cr, uid, cfdi_pac_finkok_ids, context=context)
        state = cfdi_pac_finkok.state
-
  6 I check that the state in l10n_mx attachment facturae cfdi_pac_finkok is "Signed"
-
  !python {model: ir.attachment.facturae.mx}: |
    import netsvc, tools, os, base64
    cfdi_pac_finkok_ids = self.search(cr, uid, [('payroll_id', '=', ref("hr_payslip_al_cfdi0") ), ('state', '<>', 'cancel')], limit=1)
    cfdi_pac_finkok_id = len(cfdi_pac_finkok_ids) and cfdi_pac_finkok_ids[0] or False
    state = 'no attach file'
    if cfdi_pac_finkok_id:
        cfdi_pac_finkok = self.browse(cr, uid, [cfdi_pac_finkok_id], context=context)[0]
        ir_attach_facturae_mx = cfdi_pac_finkok.file_xml_sign and cfdi_pac_finkok.file_xml_sign or False
        fdata = ir_attach_facturae_mx and ir_attach_facturae_mx.db_datas or False
        if fdata:
            state = cfdi_pac_finkok.state
            if tools.config['test_report_directory']:
                open(os.path.join(tools.config['test_report_directory'], 'l10n_mx_facturae_pac_finkok' + '_' + \
                  'hr_payslip_al_cfdi0' + '_' + 'signed' + '-' + ir_attach_facturae_mx.datas_fname),\
                  'wb+').write( base64.decodestring( fdata ) )
        else:
            state = 'no data in attach file'
    assert state=='signed', 'No signed state l10n_mx attachment facturae cfdi_pac_finkok'
-
  7 I generate a printable l10n_mx attachment facturae cfdi_pac_finkok by clicking on printable button (ID hr_payslip_al_cfdi0)
-
  !python {model: ir.attachment.facturae.mx}: |
    import netsvc, tools
    wf_service = netsvc.LocalService("workflow")
    cfdi_pac_finkok_ids = self.search(cr, uid, [('payroll_id', '=', ref("hr_payslip_al_cfdi0") ), ('state', '<>', 'cancel')], limit=1)
    cfdi_pac_finkok_id = cfdi_pac_finkok_ids and cfdi_pac_finkok_ids[0] or False
    if cfdi_pac_finkok_id:
        cfdi_pac_finkok = self.browse(cr, uid, [cfdi_pac_finkok_id])[0]
        self.signal_printable(cr, uid , cfdi_pac_finkok_ids ,context=context)
        state = cfdi_pac_finkok.state
-
  8 I check that the state in l10n_mx attachment facturae cfdi_pac_finkok is Printable (ID hr_payslip_al_cfdi0)
-
  !python {model: ir.attachment.facturae.mx}: |
    import netsvc, tools, os, base64
    cfdi_pac_finkok_ids = self.search(cr, uid, [('payroll_id', '=', ref("hr_payslip_al_cfdi0") ), ('state', '<>', 'cancel')], limit=1)
    cfdi_pac_finkok_id = cfdi_pac_finkok_ids and cfdi_pac_finkok_ids[0] or False
    state = None
    state = 'no attach file'
    if cfdi_pac_finkok_id:
        cfdi_pac_finkok = self.browse(cr, uid, [cfdi_pac_finkok_id], context=context)[0]
        ir_attach_facturae_mx = cfdi_pac_finkok.file_pdf and cfdi_pac_finkok.file_pdf or False
        fdata = ir_attach_facturae_mx and ir_attach_facturae_mx.db_datas or False
        if fdata:
            state = cfdi_pac_finkok.state
            if tools.config['test_report_directory']:
                open(os.path.join(tools.config['test_report_directory'], 'l10n_mx_facturae_pac_finkok' + '_' + \
                  'hr_payslip_al_cfdi0' + '_' + 'printable' + '-' + ir_attach_facturae_mx.datas_fname),\
                  'wb+').write( base64.decodestring( fdata ) )
        else:
            state = 'no data in attach file'
    assert state=='printable', 'No printable state l10n_mx attachment facturae cfdi_pac_finkok' 
-
  9 I generate a cancel l10n_mx attachment facturae cfdi_pac_finkok by clicking on cancel button (ID hr_payslip_al_cfdi0)
-
  !python {model: ir.attachment.facturae.mx}: |
    cfdi_pac_finkok_ids = self.search(cr, uid, [('payroll_id', '=', ref("hr_payslip_al_cfdi0") ), ('state', '<>', 'cancel')], limit=1)
    cfdi_pac_finkok_id = cfdi_pac_finkok_ids and cfdi_pac_finkok_ids[0] or False
    if cfdi_pac_finkok_id:
        self.signal_cancel(cr, uid , cfdi_pac_finkok_ids ,context=context)
        cfdi_pac_finkok = self.browse(cr, uid, [cfdi_pac_finkok_id])[0]
        state = cfdi_pac_finkok.state
    assert state=='cancel', 'No cancel state l10n_mx attachment facturae cfdi_pac_finkok'
-
  10 I check that customer payroll state is "cancel" (ID hr_payslip_al_cfdi0)
-
  !assert {model:  hr.payslip, id: hr_payslip_al_cfdi0}:
    - state == 'cancel'
-
  11 I check that customer payroll move_id is None (ID hr_payslip_al_cfdi0)
-
  !assert {model:  hr.payslip, id: hr_payslip_al_cfdi0}:
    - move_id.name == None
